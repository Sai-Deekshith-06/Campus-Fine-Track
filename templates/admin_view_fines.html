{% extends 'admin_home.html' %}

{% block header_title %}
    <div class="flex justify-between items-center mb-4"> <!-- Added margin bottom -->
        <h2 class="text-2xl font-bold text-gray-800">
            <i class="fas fa-file-invoice-dollar mr-2"></i> <!-- Added margin -->
            View Fines
        </h2>
        <div class="">
            <form method="GET" action="{{ url_for('admin.admin_view_fines') }}" class="flex space-x-2">
                <input type="text" name="student_id" placeholder="Search by Student ID" value="{{ search_student_id or '' }}" class="shadow appearance-none border rounded py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline text-sm">
                <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline text-sm">
                    <i class="fas fa-search mr-1"></i> Search
                </button>
                 <a href="{{ url_for('admin.admin_view_fines') }}" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline text-sm">Clear</a>
            </form>
        </div>
    </div>
{% endblock %}

{% block main_content %}
<div class="flex-1 overflow-auto bg-gray-50 py-4 px-6">
    <div class="bg-white shadow rounded-lg p-6">
        <!-- Filter Form -->
        <form method="GET" action="{{ url_for('admin.admin_view_fines') }}" id="filterForm" class="mb-6 pb-4 border-b border-gray-200 flex items-end space-x-4 text-sm">
             <!-- Hidden input to carry over student_id search if present -->
             {% if search_student_id %}
             <input type="hidden" name="student_id" value="{{ search_student_id }}">
             {% endif %}
            <div>
                <label for="fine_category" class="block text-sm font-medium text-gray-700">Category:</label>
                <select name="fine_category" id="fine_category" class="mt-1 block w-full py-1.5 px-2 rounded-md border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    <option value="">All</option>
                    {% for category in fine_categories %}
                        <option value="{{ category.type }}" {% if search_category == category.type %}selected{% endif %}>{{ category.type }}</option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label for="due_date" class="block text-sm font-medium text-gray-700">Due Date:</label>
                <input type="date" name="due_date" id="due_date" value="{{ search_due_date or '' }}" class="mt-1 block w-full py-1 px-2 rounded-md border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </div>

            <div>
                <label for="status" class="block text-sm font-medium text-gray-700">Status:</label>
                <select name="status" id="status" class="mt-1 block w-full py-1.5 px-2 rounded-md border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    <option value="">All</option>
                    <option value="pending" {% if search_status == 'pending' %}selected{% endif %}>Pending</option>
                    <option value="pending_approval" {% if search_status == 'pending_approval' %}selected{% endif %}>Pending Approval</option>
                    <option value="paid" {% if search_status == 'paid' %}selected{% endif %}>Paid</option>
                     <option value="rejected" {% if search_status == 'rejected' %}selected{% endif %}>Rejected</option> {# Add if using rejected status #}
                </select>
            </div>

            <div>
                <button type="submit" class="bg-indigo-500 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline text-sm">Apply Filters</button>
            </div>
             <a href="{{ url_for('admin.admin_view_fines') }}" class="text-sm text-gray-600 hover:text-indigo-600 self-center pt-2">Clear Filters</a>
        </form>
        <!-- End Filter Form -->

        <div class="overflow-x-auto">
            <table class="min-w-full leading-normal text-sm">
                <thead class="bg-gray-100">
                    <tr>
                        {# Use student_id_str which is the Roll No #}
                        <th class="px-3 py-3 border-b-2 border-gray-200 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Student ID
                        </th>
                        <th class="px-3 py-3 border-b-2 border-gray-200 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Student Name
                        </th>
                        <th class="px-3 py-3 border-b-2 border-gray-200 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Fine Category
                        </th>
                         <th class="px-3 py-3 border-b-2 border-gray-200 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Reason
                        </th>
                        <th class="px-3 py-3 border-b-2 border-gray-200 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider"> <!-- Align right -->
                            Amount
                        </th>
                        <th class="px-3 py-3 border-b-2 border-gray-200 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Issued
                        </th>
                        <th class="px-3 py-3 border-b-2 border-gray-200 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Due Date
                        </th>
                         <th class="px-3 py-3 border-b-2 border-gray-200 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Transaction ID
                        </th>
                        <th class="px-3 py-3 border-b-2 border-gray-200 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Status
                        </th>
                        <th class="px-3 py-3 border-b-2 border-gray-200 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Actions
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white">
                    {% if fines %}
                        {% for fine in fines %}
                            <tr class="hover:bg-gray-50">
                                <td class="px-3 py-3 border-b border-gray-200 bg-white text-sm">
                                    {{ fine.student_id_str | default('N/A') }}
                                </td>
                                <td class="px-3 py-3 border-b border-gray-200 bg-white text-sm">
                                    {{ fine.student_name | default('N/A') }}
                                </td>
                                <td class="px-3 py-3 border-b border-gray-200 bg-white text-sm">
                                    {{ fine.fine_category }}
                                </td>
                                 <td class="px-3 py-3 border-b border-gray-200 bg-white text-sm max-w-xs truncate" title="{{ fine.reason }}"> <!-- Truncate reason -->
                                    {{ fine.reason | truncate(50) }} {# Show first 50 chars #}
                                </td>
                                <td class="px-3 py-3 border-b border-gray-200 bg-white text-sm text-right"> <!-- Align right -->
                                    {{ "%.2f"|format(fine.amount | float) }} {# Format to 2 decimals #}
                                </td>
                                 <td class="px-3 py-3 border-b border-gray-200 bg-white text-sm">
                                    {{ fine.issue_date }}
                                </td>
                                <td class="px-3 py-3 border-b border-gray-200 bg-white text-sm">
                                    {{ fine.due_date }}
                                </td>
                                <td class="px-3 py-3 border-b border-gray-200 bg-white text-sm">
                                    {{ fine.transaction_id | default('-') }}
                                </td>
                                <td class="px-3 py-3 border-b border-gray-200 bg-white text-sm">
                                     {% if fine.status == 'pending' %}
                                        <span class="text-orange-600 font-semibold">{{ fine.status }}</span>
                                    {% elif fine.status == 'pending_approval' %}
                                        <span class="text-blue-600 font-semibold">{{ fine.status }}</span>
                                    {% elif fine.status == 'paid' %}
                                        <span class="text-green-600 font-semibold">{{ fine.status }}</span>
                                    {% elif fine.status == 'rejected' %}
                                        <span class="text-red-600 font-semibold">{{ fine.status }}</span>
                                    {% else %}
                                        {{ fine.status }}
                                    {% endif %}
                                </td>
                                <td class="px-3 py-3 border-b border-gray-200 bg-white text-sm text-center">
                                    {# Actions depend on status #}
                                    {% if fine.status == 'paid' %}
                                        <form class="inline-block" id="delete_{{ fine._id }}"  method="POST" action="{{ url_for('admin.delete_fine', fine_id=fine._id) }}" onsubmit="return confirm('Are you sure you want to delete this PAID fine? This action cannot be undone.');">
                                            <button
                                                type="submit"
                                                class="text-red-600 hover:text-red-800 text-xs font-bold py-1 px-2 rounded focus:outline-none focus:shadow-outline"
                                                title="Delete Paid Fine"
                                            ><i class="fas fa-trash-alt"></i> Delete</button>
                                        </form>
                                     {% elif fine.status == 'pending_approval' %}
                                        <a href="{{ url_for('admin.admin_approve_fines_list') }}" class="text-blue-600 hover:text-blue-800 text-xs font-bold py-1 px-2" title="Go to Approvals">
                                            Review
                                        </a>
                                    {% elif fine.status == 'pending' %}
                                        <span class="text-gray-500 text-xs italic">Awaiting Student Payment</span>
                                        {# Option to manually mark as paid (e.g., cash)? Maybe add later if needed #}
                                        {# <form id="manual_pay_{{ fine._id }}" method="POST" action="{{ url_for('admin.manual_accept_payment', fine_id=fine._id) }}">
                                            <button type="submit" class="text-green-600 hover:text-green-800 text-xs font-bold py-1 px-2" title="Manual Cash Payment">Mark Paid</button>
                                        </form> #}
                                     {% elif fine.status == 'rejected' %}
                                         <span class="text-gray-500 text-xs italic">Payment Rejected</span>
                                    {% else %}
                                         <span class="text-gray-500 text-xs italic">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                             <td colspan="10" class="text-center py-4 text-gray-500">No fines found matching the criteria.</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // Auto-submit filter form on change
    document.addEventListener('DOMContentLoaded', function () {
        const filterForm = document.getElementById('filterForm');
        const selects = filterForm.querySelectorAll('select');
        const dateInput = filterForm.querySelector('input[type="date"]');

        selects.forEach(select => {
            select.addEventListener('change', () => filterForm.submit());
        });
        if (dateInput) {
             dateInput.addEventListener('change', () => filterForm.submit());
        }
    });
</script>

{# Include flash messages block if not already in admin_home.html base template #}
{# {% include 'flash_messages.html' %} #}
{% endblock %}