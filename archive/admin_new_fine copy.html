{% extends 'admin_home.html' %}
{% block header_title %}
    <h2 class="text-2xl font-bold mb-4">
        <i class="fas fa-plus-circle"></i>
        New Fine Entry
    </h2>
{% endblock %}
{% block main_content %}
<main class="container mx-auto px-4 py-8">
    <div class="bg-white shadow rounded-lg p-6 mb-8">
        <form id="newFineForm" action="{{ url_for('admin_create_fine') }}" method="post">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700" for="student_id" >Student ID</label>
                    <input
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                        id="student_id"
                        name="student_id"
                        type="text"
                        pattern="[0-9]{2}B81A[0-9]{2}[A-Z0-9]{2}"
                        required
                    />
                </div>
                <div class="hidden">
                    <label class="block text-sm font-medium text-gray-700" for="student_name">Student Name</label>
                    <input
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                        id="student_name"
                        name="student_name"
                        type="text"
                    />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700" for="email">Email</label>
                    <input
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                        id="email"
                        name="email"
                        type="email"
                        pattern="[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}"
                    />
                </div>
                <div class="">
                    <label class="block text-sm font-medium text-gray-700" for="fine_category">Fine Category</label>
                    <select
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                        id="fine_category"
                        name="fine_category"
                        required
                    >
                        <option value="">Select Category</option>
                        {% for category in fine_categories %}
                            <option value="{{ category.type }}">{{ category.type }}</option>
                        {% endfor %}
                    </select>
                    <p class="text-red-500 text-sm mt-1 hidden" id="fineCategoryError">Fine category not found.</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700" for="amount">Fine Amount</label>
                    <input
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                        id="amount"
                        name="amount"
                        type="number"
                        min="1"
                        max="9999"
                        readonly
                        placeholder="Auto-filled"
                    />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700" for="due_date">Due Date</label>
                    <input
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                        id="due_date"
                        name="due_date"
                        type="date"
                        required
                    />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700" for="reason">Reason</label>
                    <textarea
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                        id="reason"
                        name="reason"
                        rows="3"
                        maxlength="200"
                        required
                    ></textarea>
                    <p class="text-sm text-gray-500" id="charCount">
                        0/200 characters
                    </p>
                </div>
            </div>
            <div class="flex justify-end">
                <button
                    class="bg-blue-600 text-white px-4 py-2 rounded-md"
                    type="submit"
                >Submit</button>
            </div>
        </form>
    </div>
</main>
<script>
    const roleButton = document.getElementById('roleButton');
    roleButton.textContent = "Admin";

    const reasonTextarea = document.getElementById('reason');
    const charCountDisplay = document.getElementById('charCount');
    const studentIdInput = document.getElementById('student_id');
    const emailInput = document.getElementById('email');
    const fineCategorySelect = document.getElementById('fine_category');
    const amountInput = document.getElementById('amount');
    const fineCategoryError = document.getElementById('fineCategoryError');

    function count() {
        const currentLength = reasonTextarea.value.length;
        charCountDisplay.textContent = currentLength + '/200 characters';
    }
    reasonTextarea.addEventListener('input', count);

    document.addEventListener('DOMContentLoaded', function() {
        const dueDateInput = document.getElementById('due_date');
        const today = new Date().toISOString().split('T')[0];
        dueDateInput.setAttribute('min', today);
    });

    studentIdInput.addEventListener('input', function() {
        emailInput.value = this.value + '@cvr.ac.in';
    });

    fineCategorySelect.addEventListener('change', function() {
        const category = this.value.trim();
        if (category) {
            fetch('/admin/get_fine_amount/' + category)
                .then(response => response.json())
                .then(data => {
                    if (data.amount !== undefined) {
                        amountInput.value = data.amount;
                        fineCategoryError.classList.add('hidden');
                    } else {
                        amountInput.value = '';
                        fineCategoryError.classList.remove('hidden');
                    }
                })
                .catch(error => {
                    console.error('Error fetching fine amount:', error);
                    amountInput.value = '';
                    fineCategoryError.classList.remove('hidden');
                });
        } else {
            amountInput.value = '';
            fineCategoryError.classList.add('hidden');
        }
    });
</script>
{% endblock %}